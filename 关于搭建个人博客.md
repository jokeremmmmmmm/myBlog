---
title: 关于搭建个人博客
date: 2019-07-21 15:24:42
tags: [hexo, webhook]
description: webhook, hexo, 博客, linux
---

经过折腾，终于在追钢炼的间隙把个人的博客搭好了，用来记录生活和学习，这篇文章写一下搭建博客的过程和踩过的坑。以下是用个人浅薄的知识和经验写成的白话文流水账，有出错请多多指教嘤嘤嘤。

# 1. 服务器的部署和准备

首先，我用学生价在阿里云租了个**服务器**，利用最后几个月的学生身份从阿里云身上薅了（/hāo/）点羊毛。其次买了个**域名**（冷门的会比较便宜嘤嘤嘤），然后就是跟随着阿里云的指引进行域名的备案。等待备案完后，接下来就是技术活了。



想一想我们平时访问一个网站的步骤，输入一个网址后enter就可以了，那么我们想用我们买好的域名来访问我们的博客，该如何实现这个过程？我的理解是：把域名解析到我们服务器的ip（注意是公用ip）上，然后利用服务器部署好的NGINX进行反向代理、端口监听并进行分发。



### 1.1 域名解析

​		进入到域名的管理页面（示例为阿里云），添加一个记录

![](/images/Build_a_blog/域名解析.jpg)

```
主机记录就是域名前缀，常见用法有：

www：解析后的域名为www.aliyun.com。

@：直接解析主域名 aliyun.com。

*：泛解析，匹配其他所有域名 *.aliyun.com。

mail：将域名解析为mail.aliyun.com，通常用于解析邮箱服务器。

二级域名：如：abc.aliyun.com，填写abc。

手机网站：如：m.aliyun.com，填写m。

显性URL：不支持泛解析（泛解析：将所有子域名解析到同一地址 
```

​		添加完成后如下图

![](/images/Build_a_blog/域名解析列表.jpg)



### 1.2 NGINX的部署和配置

​		先到[nginx官方下载地址](https://nginx.org/en/download.html)下载nginx的tar.gz安装包，可以在自己的电脑下载好后拉到服务器上，也可以使用wget命令直接在服务器上下载。

```
wget -c https://nginx.org/download/nginx-1.11.6.tar.gz
```

​		解压（可以自己选择目录）

```
tar -zxvf nginx-1.11.6.tar.gz
```

​		修改配置文件进行端口监听和分发

```
# 当所有server的规则都不匹配时，nginx会采用第一条server配置，所以一般第一条server当作默认的阻挡
server {
        listen 80 default_server;
        server_name _;
   
        return 404;
    }

server {
        listen       80;
        listen       [::]:80 ;
        server_name  yousite.example.com;
        root         你的网站静态页面文件的根目录;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
```

​		重启ngnix使配置生效

```
# nginx -s reload
```

​		找不到nginx安装路劲和配置文件目录？

```
# ps -ef | grep nginx
# nginx -t
```



### 1.3 配置实例安全组

​		此时我们在浏览器中访问yousite.example.com（即你配置的域名），事实上依然访问不了。我们仍需要配置实例（服务器）的安全组。

> ​	安全组是一种虚拟防火墙，具备状态检测和数据包过滤功能，用于在云端划分安全域。您可以通过配置安全组规则，允许或禁止安全组内的ECS实例对公网或私网的访问。

​		

​		在阿里云控制台中的实例列表中进入安全组配置

![](/images/Build_a_blog/安全组配置.jpg)

​		而后依次点击配置规则 - - > 入方向 - - > 添加安全组规则

![](/images/Build_a_blog/添加安全组规则.jpg)

​		添加完成后，再次访问域名，出现nginx的默认页面即为成功。



# 2.搭建博客



​		<font color=#CB4335 >**注意，这步是本人所踩的坑，对在linux环境下使用npm和hexo不感兴趣的朋友可以直接跳至第三步。**</font>

​	

​		由于之前用过github page配合hexo搭建过自己的博客，所以这次也决定继续使用hexo框架。那么我们需要相应的环境和软件，这里用到node.js（hexo依赖于此）。



## 2.1 安装node.js



### 2.1.1 下载

​		先[下载](https://nodejs.org/en/download/)安装包，同样地你可以从电脑下载拉到服务器也可以直接从服务器下载。

```
wget https://nodejs.org/dist/v6.10.1/node-v6.10.1-linux-x64.tar.xz
```

​		待下载完成后，进行下一步



### 2.1.2 解压缩

```
tar xvJf node-v6.10.1-linux-x64.tar.xz
```

​		这里我将其解压到/usr/local下

```
mv node-v6.10.1-linux-x64 /usr/local/node-v6
```



### 2.1.3 软链接到 /bin 目录

```
ln -s /usr/local/node-v6/bin/node /bin/nodeln -s /usr/local/node-v6/bin/npm /bin/npm
```



### 2.1.4 配置环境变量

```
echo 'export PATH=/usr/local/node-v6/bin:$PATH' >> /etc/profile
```

​		使环境变量生效

```
source /etc/profile
```



## 2.2 安装HEXO

​		利用npm全局安装

```
npm install -g hexo-cli
```



## 2.3 使用HEXO

​		cli初始化，<folder>为你指定的目录

```
hexo init <folder>
```

​		生成静态资源

```
hexo g
```

​		启动服务器

```
hexo s
```

​		

​		启动成功后，添加一条端口为4000的安全组配置（hexo默认端口为4000），在浏览器输入http://<服务器公共IP地址>:4000即可访问到hexo的默认页面，这里将blog解析为我所拥有域名的三级域名，并在ngnix进行端口4000的配置 ，即可使用blog,example.com访问。



​		hexo框架的使用可以在[官网文档](https://hexo.io/zh-cn/docs/index.html)中学习使用，你也可以在[主题列表](https://hexo.io/themes/)中选择自己喜欢的主题风格，在这里不再阐述。



# 3.gitbub webhook进行博客的自动部署



​		博客部署好后，那么我们要怎么编写博文？



​		如果我将hexo部署在服务器环境下，缺少了windows各种可视化软件的配合，那么我只能使用命令行进行编写，或者是在电脑写好后再拉到服务器上进行静态资源文件的生成。

​		如果我在电脑端部署，那么我发一篇博文，先要在电脑这边编写后生成静态页面，把服务器上的静态页面删除，再把新的静态资源拉到服务器上去，emmmmmm.....这种做法，不太码农，你懂我意思吧~



​		我的做法是，通过GitHub进行管理，在电脑端生成静态资源后，push到GitHub上去，触发GitHub的webhook，发送post请求，服务端接收到这个请求后运行脚本从github上pull新的静态资源，完成自动部署过更新。

​	

​		首先，我们要在电脑上安装好git、node.js，然后用npm全局安装hexo，以后就在电脑上管理博客。



​		在GitHub上创建一个新的仓库，在仓库的setting - - > Webhooks 页面配置好Payload URL（即http://你的公共ip:你要监听的端口/）和Secret，然后保存。



​		然后在服务器部署一个服务端，java、golang或者是node express等等都可以，监听你要监听的端口，收到GitHub的请求后调用脚本pull相应的分支即可。



​		注意注意注意，git命令依赖于环境变量GIT_DIR和GIT_WORK_TREE，这两个环境变量才是git真正的运行上下文。而在shell命令里直接执行cd是不会跟着改变这两个环境变量的

```
#!/bin/bash
git --git-dir='/xxx/xxx/xxx/xxx/.git' --work-tree='/xxx/xxx/xxx/xxx' pull
```



​		呼~  完成~





​		参考

- [阿里云CentOS下Hexo+Nginx建站过程]([https://qiming.info/%E9%98%BF%E9%87%8C%E4%BA%91CentOS%E4%B8%8BHexo+Nginx%E5%BB%BA%E7%AB%99%E8%BF%87%E7%A8%8B/](https://qiming.info/阿里云CentOS下Hexo+Nginx建站过程/))

- [使用 Github Webhook 自动部署 博客](https://yuerer.com/使用Github-Webhook自动部署博客/)

- [在脚本中调用git命令：指定git命令运行上下文](https://www.jianshu.com/p/8a3caeb7f266)

